<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D5YSD14H3P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D5YSD14H3P');
  </script>

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Global Finds ‚Äì Best Amazon Deals</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

<style>
:root{--dark:#111827;--accent:#f97316;--soft:#ffedd5}
.product-card{border:1px solid #e5e7eb;border-radius:16px;background:#fff;overflow:hidden;transition:.25s}
.product-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,.08)}
.badge{position:absolute;top:10px;left:10px;background:var(--accent);color:#fff;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px}
.badge-right{right:10px;left:auto;background:#000;font-size:10px}
.price{background:var(--soft);color:#9a3412;font-size:12px;font-weight:700;padding:4px 8px;border-radius:8px}
.cta{background:var(--dark);color:var(--accent);font-weight:800;padding:10px;border-radius:10px;text-align:center}
/* ÂàÜÈ°µÂ∞èÂúÜÁÇπÂä®Áîª */
.dot-active { width: 24px !important; background-color: var(--accent) !important; border-radius: 4px; }
</style>
</head>

<body class="bg-slate-50 text-slate-900">

<div class="bg-slate-800 text-slate-300 text-[10px] py-1 text-center">
  As an Amazon Associate, we earn from qualifying purchases.
</div>

<nav class="bg-white border-b px-4 py-3 sticky top-0 z-50">
  <div class="max-w-7xl mx-auto flex items-center gap-2">
    <i class="fa-solid fa-bag-shopping text-orange-500 text-2xl"></i>
    <span class="text-xl font-extrabold">
      GLOBAL<span class="text-orange-500">FINDS</span>
    </span>
  </div>
</nav>

<main class="max-w-7xl mx-auto px-4 py-8">

  <section id="promo-section" class="mb-10 hidden">
    <div class="flex items-center justify-between mb-4 gap-4">
      <div class="flex items-center gap-4">
        <h2 class="text-lg font-black">üéüÔ∏è Active Promo Codes</h2>
        <div id="promo-dots" class="flex gap-1.5"></div>
      </div>

      <select id="promoCategorySelect"
        class="border border-slate-300 rounded-xl px-3 py-2 text-sm font-semibold outline-none focus:ring-2 focus:ring-orange-500">
      </select>
    </div>

    <div id="promo-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>
  </section>

  <div class="flex items-center justify-between mb-6 gap-4 border-t pt-8">
    <h2 class="text-xl font-black">üî• Featured Deals</h2>
    <select id="categorySelect"
      class="border border-slate-300 rounded-xl px-4 py-2 text-sm font-semibold outline-none focus:ring-2 focus:ring-orange-500">
    </select>
  </div>

  <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-4">
  </div>

</main>

<script>
/* ================= CONFIG ================= */
const TRACK_ID = "site_esfinds-20";
const PRODUCT_URL = "products_data_v.json";
const PROMO_URL = "promo_codes.json";

/* ================= STATE ================= */
let allProducts = [];
let allPromos = [];
let currentCategory = "All";
let promoPage = 0;
const PROMOS_PER_PAGE = 3; // Á°Æ‰øùÂ§ßÂ±èÂπïÂè™ÊòæÁ§∫‰∏ÄË°å‰∏â‰∏™

/* ================= UTILS ================= */
function buildLink(asin){
  return `https://www.amazon.com/dp/${asin}?tag=${TRACK_ID}`;
}
function formatPrice(v){return Number(v||0).toFixed(2);}
function formatRating(v){return v ? Number(v).toFixed(1) : "N/A";}
function now(){return new Date();}

/* ================= PROMO LOGIC ================= */
function isPromoActive(p){
  const today = now();
  return new Date(p.start_at) <= today && today <= new Date(p.end_at);
}

function renderPromoCategories(){
  const sel = document.getElementById("promoCategorySelect");
  const cats = [...new Set(allPromos.map(p=>p.category))].sort();
  sel.innerHTML = `<option value="All">All Categories</option>`;
  cats.forEach(c=>{
    sel.innerHTML += `<option value="${c}">${c}</option>`;
  });
  sel.onchange = () => { promoPage = 0; renderPromos(sel.value); };
}

function renderPromos(cat="All"){
  const box = document.getElementById("promo-list");
  const dotsContainer = document.getElementById("promo-dots");
  box.innerHTML = "";
  dotsContainer.innerHTML = "";

  // 1. ËøáÊª§ÔºöÂøÖÈ°ªÊú™ËøáÊúü && Á¨¶ÂêàÁ±ªÂà´
  const filtered = allPromos.filter(p => 
    isPromoActive(p) && (cat === "All" || p.category === cat)
  );

  if(filtered.length === 0){
    document.getElementById("promo-section").classList.add("hidden");
    return;
  }
  document.getElementById("promo-section").classList.remove("hidden");

  // 2. ÂàÜÈ°µËÆ°ÁÆó
  const totalPages = Math.ceil(filtered.length / PROMOS_PER_PAGE);
  const start = promoPage * PROMOS_PER_PAGE;
  const currentItems = filtered.slice(start, start + PROMOS_PER_PAGE);

  // 3. Ê∏≤ÊüìÂàÜÈ°µÂúÜÁÇπ
  if(totalPages > 1){
    for(let i=0; i<totalPages; i++){
      const dot = document.createElement("button");
      dot.className = `h-2 w-2 rounded-full transition-all duration-300 ${i === promoPage ? 'dot-active bg-orange-500' : 'bg-slate-300'}`;
      dot.onclick = () => { promoPage = i; renderPromos(cat); };
      dotsContainer.appendChild(dot);
    }
  }

  // 4. Ê∏≤ÊüìÂç°Áâá
  currentItems.forEach(p => {
    const div = document.createElement("div");
    // ÁÇπÂáªÊï¥‰∏™Âç°ÁâáÂç≥Â§çÂà∂
    div.className = "group border-2 border-slate-100 hover:border-orange-500 rounded-2xl bg-white p-4 transition-all cursor-pointer relative flex flex-col gap-2";
    div.onclick = () => copyAndGo(p.promo_code, p.brand);
    
    div.innerHTML = `
      <div class="flex justify-between items-start">
        <span class="text-[10px] font-bold uppercase tracking-wider text-orange-500">${p.category}</span>
        <span class="text-[10px] text-slate-400">Ends ${new Date(p.end_at).toLocaleDateString()}</span>
      </div>
      <div class="text-sm font-bold text-slate-800">Save ${p.discount_percent}% on ${p.brand}</div>
      <div class="mt-2 flex items-center justify-between bg-slate-50 border border-dashed border-slate-300 rounded-lg p-2 group-hover:bg-orange-50 group-hover:border-orange-200">
        <code class="text-sm font-mono font-black text-slate-700">${p.promo_code}</code>
        <span class="text-[10px] font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded">TAP TO COPY</span>
      </div>
    `;
    box.appendChild(div);
  });
}

function copyAndGo(code, brand){
  navigator.clipboard.writeText(code);
  // ÁÆÄÂçïÁöÑËßÜËßâÂèçÈ¶à
  const tempAlert = document.createElement("div");
  tempAlert.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full z-[100] text-sm font-bold shadow-xl animate-bounce";
  tempAlert.innerText = `Code ${code} Copied!`;
  document.body.appendChild(tempAlert);
  
  setTimeout(() => {
    tempAlert.remove();
    const match = allProducts.find(p => p.title?.toLowerCase().includes(brand.toLowerCase()));
    window.open(match ? buildLink(match.asin) : "https://www.amazon.com/?tag="+TRACK_ID);
  }, 800);
}

/* ================= PRODUCT LOGIC ================= */
function scoreProduct(p){
  const rating = Number(p.review_rating || 0);
  const reviews = Math.log10((p.review_count || 0) + 1);
  const price = Number(p.price_discount || 999);
  const priceFactor = price > 0 ? 1 / Math.sqrt(price) : 0;
  return rating * reviews * priceFactor + Math.random()*0.15;
}

function renderProducts(){
  const grid=document.getElementById("product-grid");
  grid.innerHTML="";
  let list = currentCategory === "All" ? allProducts : allProducts.filter(p=>p.category_name === currentCategory);

  list.map(p=>({...p,_s:scoreProduct(p)}))
    .sort((a,b)=>b._s-a._s)
    .slice(0,60)
    .forEach(p=>{
      const d=document.createElement("div");
      d.className="product-card";
      d.innerHTML=`
      <div class="relative bg-slate-100 aspect-square">
        ${p.discount_percent?`<span class="badge">-${p.discount_percent}%</span>`:""}
        <span class="badge badge-right">Amazon</span>
        <a href="${buildLink(p.asin)}" target="_blank">
          <img src="${p.main_image}" class="w-full h-full object-contain p-6" loading="lazy">
        </a>
      </div>
      <div class="p-4 flex flex-col gap-2">
        <h3 class="text-sm font-bold line-clamp-3 h-12">${p.title}</h3>
        <div class="flex justify-between items-center mt-auto">
          <span class="price">${p.currency}${formatPrice(p.price_discount)}</span>
          ${p.price_original?`<span class="line-through text-slate-400 text-[10px]">${p.currency}${formatPrice(p.price_original)}</span>`:""}
        </div>
        <div class="text-[11px] text-slate-500">
          ‚≠ê ${formatRating(p.review_rating)} (${p.review_count||0})
        </div>
        <a href="${buildLink(p.asin)}" target="_blank" class="cta text-xs">View Deal</a>
      </div>`;
      grid.appendChild(d);
    });
}

function renderCategorySelect(cats){
  const sel=document.getElementById("categorySelect");
  sel.innerHTML=`<option>All</option>`;
  cats.forEach(c=>sel.innerHTML+=`<option>${c}</option>`);
  sel.onchange=()=>{currentCategory=sel.value;renderProducts();}
}

/* ================= INIT ================= */
async function init(){
  try {
    const [pData, promoData] = await Promise.all([
      fetch(PRODUCT_URL).then(r => r.json()),
      fetch(PROMO_URL).then(r => r.json())
    ]);

    allProducts = pData;
    // ÂàùÂßãÂåñÊó∂Â∞±ËøáÊª§ÊéâËøáÊúüÁöÑ
    allPromos = promoData.filter(isPromoActive);

    renderPromoCategories();
    renderPromos();

    const cats=[...new Set(allProducts.map(p=>p.category_name).filter(Boolean))].sort();
    renderCategorySelect(cats);
    renderProducts();
  } catch (e) {
    console.error("Initialization failed", e);
  }
}

init();
</script>

</body>
</html>
