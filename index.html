<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D5YSD14H3P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D5YSD14H3P');
  </script>

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Global Finds ‚Äì Best Amazon Deals</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    :root{
      --ink:#0b1220;
      --muted:#64748b;
      --accent:#f97316;
      --accent2:#22c55e;
      --soft:#fff7ed;
      --card:#ffffff;
      --border:#e5e7eb;
      --shadow:0 14px 40px rgba(2,6,23,.08);
    }

    body{color:var(--ink)}
    .topbar{background:linear-gradient(90deg,#0b1220,#111827);}

    /* Card: Â∑ÆÂºÇÂåñÂ∏ÉÂ±ÄÔºàÊ†áÈ¢ò‰ºòÂÖà + Ê†áÁ≠æÂú®‰∏ã + ‰ª∑Ê†º‰æßÈáçÔºâ */
    .deal-card{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--card);
      overflow:hidden;
      transition:.22s ease;
    }
    .deal-card:hover{
      transform:translateY(-3px);
      box-shadow:var(--shadow);
      border-color:#fed7aa;
    }

    .media{
      position:relative;
      background:radial-gradient(1200px 300px at 20% 0%, #fff7ed 0%, #f8fafc 55%, #f1f5f9 100%);
      aspect-ratio: 1 / 1;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid var(--border);
      background:#fff;
      color:#0f172a;
      white-space:nowrap;
    }
    .pill-accent{
      border-color:#fed7aa;
      background:#fff7ed;
      color:#9a3412;
    }
    .pill-green{
      border-color:#bbf7d0;
      background:#ecfdf5;
      color:#166534;
    }
    .pill-blue{
      border-color:#bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
    }

    .stamp{
      position:absolute;
      top:10px;
      left:10px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:950;
      background:rgba(11,18,32,.92);
      color:#fff;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
    }
    .stamp i{ color: var(--accent); }

    .fav{
      position:absolute;
      top:10px;
      right:10px;
      width:30px;
      height:30px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 26px rgba(0,0,0,.10);
      cursor:pointer;
      user-select:none;
    }
    .fav i{ color:#94a3b8; }
    .fav:hover i{ color:#ef4444; }

    .promo-flag{
      position:absolute;
      bottom:10px;
      left:10px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:950;
      background:#16a34a;
      color:#fff;
      box-shadow:0 12px 26px rgba(22,163,74,.22);
      letter-spacing:.2px;
    }

    .title{
      font-size:13px;
      font-weight:950;
      line-height:1.25;
      display:-webkit-box;
      line-clamp: 2;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:2.6em;
    }

    .price-row{
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .price-now{
      font-size:20px;
      font-weight:1000;
      letter-spacing:-.2px;
    }
    .price-old{
      font-size:12px;
      font-weight:900;
      color:#94a3b8;
      text-decoration:line-through;
    }

    .meta-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }
    .meta-left{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .heat{
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#475569;
      font-size:12px;
      font-weight:950;
    }
    .heat i{ color:#0f172a; opacity:.6; }

    .subline{
      font-size:11px;
      font-weight:850;
      color:#94a3b8;
      margin-top:8px;
    }

    .cta{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:#0b1220;
      color:#fff;
      font-weight:950;
      padding:10px 12px;
      border-radius:12px;
      text-align:center;
      transition:.18s ease;
      margin-top:10px;
    }
    .cta:hover{ transform:translateY(-1px); }
    .cta span{ color: #ffedd5; }

    /* Tabs */
    .tab-active{ color:var(--accent); border-bottom:3px solid var(--accent); }

    /* Search */
    .searchbox{
      border:1px solid #cbd5e1;
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      font-weight:800;
      outline:none;
      background:#fff;
    }
    .searchbox:focus{
      box-shadow:0 0 0 2px rgba(249,115,22,.35);
      border-color:#fb923c;
    }

    /* Sync badge */
    .sync-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:950;
      color:#0f172a;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 12px;
      box-shadow:0 12px 24px rgba(2,6,23,.06);
    }
    .sync-badge i{ color:var(--accent); }

    /* Promo list cards */
    .promo-card{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:14px;
      transition:.2s ease;
      cursor:pointer;
    }
    .promo-card:hover{ box-shadow:var(--shadow); border-color:#fed7aa; transform:translateY(-2px); }
    .promo-code{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight:1000;
      letter-spacing:.3px;
      font-size:14px;
    }

    /* Toast */
    .toast{
      position:fixed;
      bottom:24px;
      left:50%;
      transform:translateX(-50%);
      background:#0b1220;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      z-index:200;
      font-size:13px;
      font-weight:950;
      box-shadow:0 16px 38px rgba(0,0,0,.18);
    }
  </style>
</head>

<body class="bg-slate-50">

  <div class="topbar text-slate-200 text-[11px] py-2 text-center px-3">
    Como Afiliado de Amazon, gano con las compras que cumplan los requisitos.
  </div>

  <nav class="bg-white border-b px-4 py-3 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center gap-2">
      <i class="fa-solid fa-bag-shopping text-orange-500 text-2xl"></i>
      <span class="text-xl font-extrabold tracking-tight">
        GLOBAL<span class="text-orange-500">FINDS</span>
      </span>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- Sync info -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <div class="sync-badge">
        <i class="fa-solid fa-rotate"></i>
        <span id="syncText">Cargando datos...</span>
      </div>
      <div class="text-[11px] font-bold text-slate-500">
        Mostramos ofertas y cupones activos; se filtran autom√°ticamente los caducados.
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-6 mb-6 border-b">
      <button id="tabDeals" class="pb-3 font-black tab-active">üî• Destacados</button>
      <button id="tabPromo" class="pb-3 font-black">üéüÔ∏è C√≥digos activos</button>
    </div>

    <!-- PROMO SECTION -->
    <section id="promo-section" class="hidden mb-10">
      <div class="flex items-center justify-between mb-4 gap-4 flex-wrap">
        <div class="flex items-center gap-3">
          <h2 class="text-lg font-black">üéüÔ∏è C√≥digos activos</h2>
          <div id="promo-dots" class="flex gap-1.5"></div>
        </div>

        <select id="promoCategorySelect"
          class="border border-slate-300 rounded-xl px-3 py-2 text-sm font-semibold outline-none focus:ring-2 focus:ring-orange-500">
        </select>
      </div>

      <div id="promo-empty" class="hidden border border-slate-200 bg-white rounded-2xl p-6 text-sm text-slate-600">
        No hay cupones activos ahora (posible fallo de fechas o ya expiraron).
      </div>

      <div id="promo-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- DEAL SECTION -->
    <section id="deal-section">
      <div class="flex items-center justify-between mb-6 gap-4 flex-wrap">
        <h2 class="text-xl font-black">üî• Destacados</h2>

        <div class="flex items-center gap-3 w-full md:w-auto">
          <div class="relative flex-1 md:w-[380px]">
            <i class="fa-solid fa-magnifying-glass text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
            <input id="searchInput" class="searchbox w-full pl-11 pr-10"
              placeholder="Buscar por producto / ASIN / palabra clave..." />
            <button id="clearSearchBtn"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-700 font-black"
              title="Clear">‚úï</button>
          </div>

          <select id="categorySelect"
            class="border border-slate-300 rounded-xl px-4 py-2 text-sm font-semibold outline-none focus:ring-2 focus:ring-orange-500">
          </select>
        </div>
      </div>

      <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    </section>

  </main>

<script>
/* ================= CONFIG ================= */
const TRACK_ID = "site_esfinds";             // ‰∏çÂ∏¶Â∞æÊ§é
const PRODUCT_URL = "products_data_v.json";
const PROMO_URL   = "promo_codes.json";

const AMAZON_DOMAIN_MAP = {
  US: "amazon.com",
  CA: "amazon.ca",
  ES: "amazon.es",
  DE: "amazon.de",
  FR: "amazon.fr",
  IT: "amazon.it",
  UK: "amazon.co.uk",
  GB: "amazon.co.uk",
  JP: "amazon.co.jp"
};
const AMAZON_TAG_SUFFIX_MAP = {
  US: "-20",
  CA: "-20",
  ES: "-21",
  DE: "-21",
  FR: "-21",
  IT: "-21",
  UK: "-21",
  GB: "-21",
  JP: "-22"
};

/* Infinite render params */
const PRODUCTS_PER_BATCH = 120;
let _sortedFilteredProducts = [];
let _renderedCount = 0;
let _observer = null;
let _sentinel = null;

/* ================= DOM ================= */
const promoSection = document.getElementById("promo-section");
const dealSection  = document.getElementById("deal-section");
const tabDeals     = document.getElementById("tabDeals");
const tabPromo     = document.getElementById("tabPromo");
const promoEmpty   = document.getElementById("promo-empty");
const searchInput  = document.getElementById("searchInput");
const clearSearchBtn = document.getElementById("clearSearchBtn");
const syncTextEl   = document.getElementById("syncText");

/* ================= STATE ================= */
let allProducts = [];
let allPromosRaw = [];
let allPromosActive = [];
let currentCategory = "All";
let promoPage = 0;
const PROMOS_PER_PAGE = 3;
let searchQuery = "";

/* ================= UTILS ================= */
function now(){ return new Date(); }
function formatPrice(v){ return Number(v||0).toFixed(2); }
function formatRating(v){ return v ? Number(v).toFixed(1) : "N/A"; }
function pad2(n){ return String(n).padStart(2,"0"); }

function parseDateSmart(input){
  if(!input) return null;
  if(input instanceof Date) return input;
  let s = String(input).trim();
  
  // ÊîØÊåÅ D/M/YYYY HH:MM:SS Ê†ºÂºè (Ê¨ßÊ¥≤Ê†ºÂºè: Êó•/Êúà/Âπ¥ Êó∂:ÂàÜ:Áßí)
  const dmy = /^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})$/.exec(s);
  if (dmy) {
    const day = parseInt(dmy[1], 10);
    const month = parseInt(dmy[2], 10) - 1; // ËΩ¨‰∏∫0-11
    const year = parseInt(dmy[3], 10);
    const hour = parseInt(dmy[4], 10);
    const min = parseInt(dmy[5], 10);
    const sec = parseInt(dmy[6], 10);
    // JSONÊï∞ÊçÆÊù•Ëá™‰∏úÂÖ´Âå∫(UTC+8)ÔºåÈúÄË¶ÅËΩ¨Êç¢Âà∞È©¨Âæ∑ÈáåÊó∂Âå∫(UTC+1)
    // Â∑ÆÂÄº‰∏∫7Â∞èÊó∂
    const d = new Date(Date.UTC(year, month, day, hour, min, sec) - 7 * 3600000);
    if (!isNaN(d.getTime())) return d;
  }
  
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(:\d{2})?$/.test(s)) s = s.replace(/\s+/, "T");
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) s = s + "T00:00:00";
  // JSONÊï∞ÊçÆÊù•Ëá™‰∏úÂÖ´Âå∫(UTC+8)ÔºåÈúÄË¶ÅËΩ¨Êç¢Âà∞È©¨Âæ∑ÈáåÊó∂Âå∫(UTC+1)
  // Â∑ÆÂÄº‰∏∫7Â∞èÊó∂
  const d = new Date(s + "+08:00"); // ÊòéÁ°ÆÊåáÂÆö‰∏∫‰∏úÂÖ´Âå∫Êó∂Èó¥
  if (isNaN(d.getTime())) return null;
  return d;
}

function formatRelativeTime(d){
  if(!d || !(d instanceof Date) || isNaN(d.getTime())) return "desconocido";
  const diffMs = Date.now() - d.getTime();
  const diffSec = Math.max(0, Math.floor(diffMs/1000));
  const mins = Math.floor(diffSec/60);
  const hrs  = Math.floor(mins/60);
  const days = Math.floor(hrs/24);
  if (days > 0) return `hace ${days} d√≠a${days>1?"s":""}`;
  if (hrs  > 0) return `hace ${hrs} hora${hrs>1?"s":""}`;
  if (mins > 0) return `hace ${mins} min`;
  return "hace unos segundos";
}

function formatDateTimeLocal(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function toast(msg){
  const t=document.createElement("div");
  t.className="toast";
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 1200);
}

/* Link builder */
function buildLink(asin, currency){
  // Âº∫Âà∂Ê†πÊçÆË¥ßÂ∏ÅÂà§Êñ≠ÂõΩÂÆ∂
  let domain = "amazon.com";
  let suffix = "-20";
  
  if (currency === "‚Ç¨") {
    domain = "amazon.es";
    suffix = "-21";
  } else if (currency === "$") {
    domain = "amazon.com";
    suffix = "-20";
  }

  return `https://www.${domain}/dp/${asin}?tag=${TRACK_ID}${suffix}`;
}

/* ================= Sync Time ================= */
let _productsSyncDate = null;
let _promosSyncDate = null;
let _syncTicker = null;

function extractSyncDate(jsonData, res){
  try{
    if(jsonData && !Array.isArray(jsonData)){
      const meta = jsonData.meta || jsonData._meta || jsonData.info || {};
      const t1 = meta.synced_at || meta.generated_at || meta.updated_at || meta.created_at;
      const d1 = parseDateSmart(t1);
      if(d1) return d1;

      const t2 = jsonData.synced_at || jsonData.generated_at || jsonData.updated_at || jsonData.created_at;
      const d2 = parseDateSmart(t2);
      if(d2) return d2;
    }

    const arr = Array.isArray(jsonData) ? jsonData : (jsonData?.data || []);
    if(Array.isArray(arr) && arr.length){
      const keys = ["synced_at","updated_at","created_at","collected_at","create_time","CreateTime","datetime"];
      const dates = [];
      for(const it of arr){
        for(const k of keys){
          if(it && it[k]){
            const dd = parseDateSmart(it[k]);
            if(dd) dates.push(dd);
          }
        }
      }
      if(dates.length){
        const maxT = Math.max(...dates.map(x=>x.getTime()));
        return new Date(maxT);
      }
    }

    const lm = res?.headers?.get("last-modified");
    const dLm = parseDateSmart(lm);
    if(dLm) return dLm;

  }catch(e){}
  return null;
}

function renderSyncText(){
  if(!_productsSyncDate){
    syncTextEl.textContent = "Datos: sin informaci√≥n de actualizaci√≥n";
    return;
  }
  const staleHours = (Date.now() - _productsSyncDate.getTime())/3600000;
  const warn = (staleHours >= 24) ? " ‚ö†Ô∏è" : "";
  syncTextEl.textContent = `Actualizado Ofertas: ${formatRelativeTime(_productsSyncDate)}${warn}`;
}

function startSyncTicker(){
  if(_syncTicker) clearInterval(_syncTicker);
  _syncTicker = setInterval(renderSyncText, 60*1000);
}

/* ================= Tabs ================= */
tabDeals.onclick = () => {
  dealSection.classList.remove("hidden");
  promoSection.classList.add("hidden");
  tabDeals.classList.add("tab-active");
  tabPromo.classList.remove("tab-active");
};
tabPromo.onclick = () => {
  promoSection.classList.remove("hidden");
  dealSection.classList.add("hidden");
  tabPromo.classList.add("tab-active");
  tabDeals.classList.remove("tab-active");
};

/* ================= Promo ================= */
function parseAmazonRawDate(raw, type){
  if(!raw) return null;
  const reg = type === "start"
    ? /Start Date:\s*([A-Za-z]{3}\s+\d{2},\s+\d{4}\s+at\s+\d{1,2}:\d{2}\s+[AP]M)\s+(PST|PDT)/i
    : /End Date:\s*([A-Za-z]{3}\s+\d{2},\s+\d{4}\s+at\s+\d{1,2}:\d{2}\s+[AP]M)\s+(PST|PDT)/i;
  const m = raw.match(reg);
  if(!m) return null;
  const datePart = m[1].replace(" at ", " ");
  const tz = m[2] === "PDT" ? "-07:00" : "-08:00";
  const d = new Date(`${datePart} ${tz}`);
  return isNaN(d) ? null : d;
}

function isPromoActive(p){
  let st = parseAmazonRawDate(p.raw_text, "start");
  let ed = parseAmazonRawDate(p.raw_text, "end");

  if(!st) st = parseDateSmart(p.start_at || p.startAt || p.start);
  if(!ed) ed = parseDateSmart(p.end_at   || p.endAt   || p.end);

  if(!st || !ed) return false;

  const t = Date.now();
  return st.getTime() <= t && t <= ed.getTime();
}

function renderPromoCategories(promos){
  const sel = document.getElementById("promoCategorySelect");
  const cats = [...new Set(promos.map(p=>p.category).filter(Boolean))].sort();
  sel.innerHTML = `<option value="All">Todas las categor√≠as</option>`;
  cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
  sel.onchange = () => { promoPage = 0; renderPromos(sel.value); };
}

function copyAndGo(p){
  const code = p.promo_code || "";
  const link = p.link || "";

  if(code){
    navigator.clipboard?.writeText(code).catch(()=>{});
    toast(`C√≥digo copiado: ${code}`);
  }else{
    toast("Copiado");
  }

  setTimeout(()=>{
    if(link){
      window.open(link, "_blank");
      return;
    }
    const brand = (p.brand || "").toLowerCase().trim();
    if(brand){
      const match = allProducts.find(x => (x.title||"").toLowerCase().includes(brand));
      if(match?.asin){
        const matchCur = match.currency && String(match.currency).trim() ? String(match.currency).trim() : "$";
        window.open(buildLink(match.asin, matchCur), "_blank");
        return;
      }
    }
    window.open("https://www.amazon.es/?tag="+TRACK_ID+(AMAZON_TAG_SUFFIX_MAP["ES"]||"-21"), "_blank");
  }, 350);
}

function renderPromos(cat="All"){
  const list = document.getElementById("promo-list");
  list.innerHTML = "";

  const filtered = allPromosActive.filter(p => cat==="All" || p.category===cat);

  if(!filtered.length){
    promoEmpty.classList.remove("hidden");
    return;
  }
  promoEmpty.classList.add("hidden");

  filtered.forEach(p => {
    const ed = parseAmazonRawDate(p.raw_text, "end") || parseDateSmart(p.end_at || p.endAt || p.end);
    const endText = ed ? ed.toLocaleDateString() : "Tiempo limitado";

    const div = document.createElement("div");
    div.className = "promo-card";
    div.onclick = () => copyAndGo(p);

    div.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="pill pill-blue">${(p.category || "CUP√ìN").toUpperCase()}</span>
            ${p.discount_percent ? `<span class="pill pill-green">-${p.discount_percent}%</span>` : ``}
            <span class="pill pill-accent">Hasta: ${endText}</span>
          </div>

          <div class="text-[13px] font-black text-slate-800">
            ${p.brand ? `Ahorra en <span class="text-orange-600">${p.brand}</span>` : `Ahorra en art√≠culos seleccionados`}
          </div>
        </div>

        <i class="fa-solid fa-copy text-slate-300 text-xl"></i>
      </div>

      <div class="mt-3 flex items-center justify-between bg-slate-50 border border-dashed border-slate-300 rounded-xl p-3">
        <div class="promo-code text-slate-800">${p.promo_code || "‚Äî"}</div>
        <div class="text-[10px] font-black text-orange-600 bg-orange-100 px-3 py-1.5 rounded-full">TOCAR PARA COPIAR</div>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ================= Products ================= */
function scoreProduct(p){
  const rating = Number(p.review_rating || 0);
  const reviews = Math.log10((p.review_count || 0) + 1);
  const price = Number(p.price_discount || 999);
  const priceFactor = price > 0 ? 1 / Math.sqrt(price) : 0;
  return rating * reviews * priceFactor + Math.random()*0.15;
}

function matchSearch(p, q){
  if(!q) return true;
  const s = q.toLowerCase();
  const title = (p.title || "").toLowerCase();
  const asin  = (p.asin  || "").toLowerCase();
  const cat   = (p.category_name || "").toLowerCase();
  const mp    = (p.marketplace || "").toLowerCase();
  return title.includes(s) || asin.includes(s) || cat.includes(s) || mp.includes(s);
}

function getFilteredSortedList(){
  let list = currentCategory === "All"
    ? allProducts
    : allProducts.filter(p=>p.category_name === currentCategory);

  list = list.filter(p => matchSearch(p, searchQuery));

  return list
    .map(p=>({...p,_s:scoreProduct(p)}))
    .sort((a,b)=>{
      const aCur = (a.currency || "").trim();
      const bCur = (b.currency || "").trim();
      // Ê¨ßÂÖÉ ‚Ç¨ ÊéíÂâçÈù¢
      if (aCur === "‚Ç¨" && bCur !== "‚Ç¨") return -1;
      if (aCur !== "‚Ç¨" && bCur === "‚Ç¨") return 1;
      return b._s-a._s;
    });
}

function ensureInfiniteObserver(){
  const grid = document.getElementById("product-grid");

  if(!_sentinel){
    _sentinel = document.createElement("div");
    _sentinel.id = "infinite-sentinel";
    _sentinel.className = "w-full col-span-full h-10";
    grid.parentElement.appendChild(_sentinel);
  }

  if(_observer){
    try{ _observer.disconnect(); }catch(e){}
    _observer = null;
  }

  _observer = new IntersectionObserver((entries)=>{
    const e = entries && entries[0];
    if(!e || !e.isIntersecting) return;
    appendNextBatch();
  },{
    root: null,
    rootMargin: "800px",
    threshold: 0.01
  });

  _observer.observe(_sentinel);
}

function appendNextBatch(){
  const grid=document.getElementById("product-grid");
  if(!_sortedFilteredProducts || !_sortedFilteredProducts.length) return;
  if(_renderedCount >= _sortedFilteredProducts.length) return;

  const next = _sortedFilteredProducts.slice(_renderedCount, _renderedCount + PRODUCTS_PER_BATCH);
  _renderedCount += next.length;

  next.forEach(p=>{
    const d=document.createElement("div");
    d.className="deal-card";

    const mpOrig = String(p.marketplace||"").toUpperCase();
    const cur = (p.currency && String(p.currency).trim())
      ? String(p.currency).trim()
      : "$";

    let mp = "US"; // ÈªòËÆ§
    if (cur === "‚Ç¨") {
      mp = "ES"; // Ê¨ßÂÖÉ -> Ë•øÁè≠Áâô
    } else if (cur === "$") {
      mp = "US"; // ÁæéÂÖÉ -> ÁæéÂõΩ
    } else {
      // ÂÖ∂ÂÆÉË¥ßÂ∏ÅÁ¨¶Âè∑ÁöÑÂ§áÁî®ÈÄªËæë
      mp = String(p.marketplace || "ES").toUpperCase();
    }

    const isPromoCode = (String(p.coupon_type || "").toLowerCase().trim() === "promo code");

    const discountText = p.discount_percent ? `${p.discount_percent}%` : "";
    const typeText = isPromoCode ? "C√≥digo" : (p.coupon_type ? String(p.coupon_type) : "Oferta");

    let heatCount = Number(p.like_count ?? p.likes ?? p.thumbsup ?? p.upvotes ?? 0) || 0;
    // Â¶ÇÊûúÂéüÊï∞ÊçÆ‰∏∫0ÔºåÈöèÊú∫ÁîüÊàêÁÉ≠Â∫¶Êï∞ÊçÆ
    if (heatCount === 0) {
      heatCount = Math.floor(Math.random() * 150) + 5; // 5-155 ‰πãÈó¥ÁöÑÈöèÊú∫Êï∞
    }

    d.innerHTML = `
      <div class="media">
        <span class="stamp"><i class="fa-solid fa-circle-check"></i> Checked</span>
        <span class="fav" title="Guardar"><i class="fa-regular fa-heart"></i></span>

        ${isPromoCode ? `<span class="promo-flag"><i class="fa-solid fa-ticket"></i> C√≥digo activo</span>` : ``}

        <a href="${buildLink(p.asin, cur)}" target="_blank" rel="noopener">
          <img src="${p.main_image}" class="w-full h-full object-contain p-6" loading="lazy">
        </a>
      </div>

      <div class="p-4 flex flex-col">

        <div class="title">${p.title || ""}</div>

        <div class="meta-row">
          <div class="meta-left">
            ${discountText ? `<span class="pill pill-green"><i class="fa-solid fa-tag"></i> -${discountText}</span>` : ``}
            <span class="pill pill-accent"><i class="fa-solid fa-bolt"></i> ${typeText}</span>
          </div>

          <div class="heat" title="Popularidad">
            <i class="fa-regular fa-thumbs-up"></i>
            <span>${heatCount}</span>
          </div>
        </div>

        <div class="mt-3 flex items-end justify-between gap-3">
          <div class="price-row">
            <div class="price-now">${cur}${formatPrice(p.price_discount)}</div>
            ${p.price_original ? `<div class="price-old">${cur}${formatPrice(p.price_original)}</div>` : ``}
          </div>
          <div class="text-[11px] font-bold text-slate-500">
            ‚≠ê ${formatRating(p.review_rating)} (${p.review_count||0})
          </div>
        </div>

        <div class="subline">Enviado por Amazon</div>

        ${isPromoCode ? `
        <a href="https://wa.me/message/INCWNKPORGSSN1" target="_blank" rel="noopener" class="cta" style="background:#25d366;">
          <i class="fa-brands fa-whatsapp"></i>
          <span>Obtener c√≥digo</span>
        </a>
        ` : `
    <a href="${buildLink(p.asin, cur)}" target="_blank" rel="noopener" class="cta">
          
          <i class="fa-solid fa-arrow-up-right-from-square"></i>
          <span>Ver detalle</span>
        </a>
        `}
      </div>
    `;
    grid.appendChild(d);
  });
}

function renderProducts(){
  const grid=document.getElementById("product-grid");
  grid.innerHTML="";
  _sortedFilteredProducts = getFilteredSortedList();
  _renderedCount = 0;
  ensureInfiniteObserver();
  appendNextBatch();
}

function renderCategorySelect(cats){
  const sel=document.getElementById("categorySelect");
  sel.innerHTML=`<option>All</option>`;
  cats.forEach(c=>sel.innerHTML+=`<option>${c}</option>`);
  sel.onchange=()=>{currentCategory=sel.value;renderProducts();}
}

/* ================= Search ================= */
let _searchTimer = null;
function setSearch(q){
  searchQuery = (q || "").trim();
  renderProducts();
}
searchInput.addEventListener("input", (e)=>{
  const v = e.target.value || "";
  if(_searchTimer) clearTimeout(_searchTimer);
  _searchTimer = setTimeout(()=>setSearch(v), 180);
});
clearSearchBtn.onclick = ()=>{
  searchInput.value = "";
  setSearch("");
};

/* ================= INIT ================= */
async function init(){
  try{
    const [pRes, promoRes] = await Promise.all([fetch(PRODUCT_URL), fetch(PROMO_URL)]);
    if(!pRes.ok) throw new Error(`products fetch failed: ${pRes.status}`);
    if(!promoRes.ok) throw new Error(`promo fetch failed: ${promoRes.status}`);

    const [pJson, promoJson] = await Promise.all([pRes.json(), promoRes.json()]);

    allProducts  = Array.isArray(pJson) ? pJson : (pJson?.data || []);
    allPromosRaw = Array.isArray(promoJson) ? promoJson : (promoJson?.data || []);

    // Ëá™Âä®Ë°• categoryÔºàÂ¶ÇÊûúÁº∫Â§±Ôºâ
    allPromosRaw = allPromosRaw.map(p=>{
      if(!p.category && p.raw_text){
        p.category = String(p.raw_text).split("\n")[0].trim();
      }
      return p;
    });

    // ÂêåÊ≠•Êó∂Èó¥ÊòæÁ§∫ÔºàÂ§öÊù•Ê∫êÂÖúÂ∫ïÔºâ
    _productsSyncDate = extractSyncDate(pJson, pRes) || new Date();
    _promosSyncDate   = extractSyncDate(promoJson, promoRes) || null;
    renderSyncText();
    startSyncTicker();

    // ËøáÊª§ active promo
    allPromosActive = allPromosRaw.filter(p=> isPromoActive(p));

    renderPromoCategories(allPromosRaw.length ? allPromosRaw : allPromosActive);
    renderPromos("All");

    const cats=[...new Set(allProducts.map(p=>p.category_name).filter(Boolean))].sort();
    renderCategorySelect(cats);
    renderProducts();

  }catch(e){
    console.error(e);
    tabPromo.click();
    promoEmpty.classList.remove("hidden");
    promoEmpty.textContent = "Error al iniciar: abre la consola para ver detalles (com√∫n: JSON 404 o CORS).";
    syncTextEl.textContent = "No se pudo cargar la informaci√≥n de actualizaci√≥n";
  }
}

init();
</script>

</body>
</html>
